apiVersion: batch/v1
kind: Job
metadata:
  name: velero-credentials-transformer
  namespace: velero
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      serviceAccountName: velero-credentials-transformer
      restartPolicy: OnFailure
      containers:
      - name: transformer
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e

          # Wait for the raw secret to be created
          timeout=60
          while [ $timeout -gt 0 ]; do
            if kubectl get secret velero-minio-credentials-raw -n velero >/dev/null 2>&1; then
              echo "Raw secret found"
              break
            fi
            echo "Waiting for raw secret..."
            sleep 2
            timeout=$((timeout-2))
          done

          if [ $timeout -le 0 ]; then
            echo "Timeout waiting for raw secret"
            exit 1
          fi

          # Extract credentials
          ACCESS_KEY=$(kubectl get secret velero-minio-credentials-raw -n velero -o jsonpath='{.data.MINIO_ACCESS_KEY}' | base64 -d)
          SECRET_KEY=$(kubectl get secret velero-minio-credentials-raw -n velero -o jsonpath='{.data.MINIO_SECRET_KEY}' | base64 -d)

          # Create the cloud credentials file
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: velero-minio-credentials
            namespace: velero
          type: Opaque
          stringData:
            cloud: |
              [default]
              aws_access_key_id=${ACCESS_KEY}
              aws_secret_access_key=${SECRET_KEY}
          EOF

          echo "Velero credentials secret created successfully"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: velero-credentials-transformer
  namespace: velero
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: velero-credentials-transformer
  namespace: velero
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: velero-credentials-transformer
  namespace: velero
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: velero-credentials-transformer
subjects:
- kind: ServiceAccount
  name: velero-credentials-transformer
  namespace: velero
