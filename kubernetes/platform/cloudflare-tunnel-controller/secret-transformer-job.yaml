# Job to transform Infisical secret keys to match deployment expectations
# Runs once to create cloudflare-api secret with kebab-case keys
# from cloudflare-api-infisical secret with SCREAMING_SNAKE_CASE keys
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-transformer
  namespace: cloudflare-tunnel-controller
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-transformer
  namespace: cloudflare-tunnel-controller
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-transformer
  namespace: cloudflare-tunnel-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: secret-transformer
subjects:
- kind: ServiceAccount
  name: secret-transformer
  namespace: cloudflare-tunnel-controller
---
apiVersion: batch/v1
kind: Job
metadata:
  name: transform-cloudflare-secret
  namespace: cloudflare-tunnel-controller
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    spec:
      serviceAccountName: secret-transformer
      restartPolicy: OnFailure
      containers:
      - name: transform
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          # Wait for source secret to exist
          until kubectl get secret cloudflare-api-infisical -n cloudflare-tunnel-controller >/dev/null 2>&1; do
            echo "Waiting for cloudflare-api-infisical secret..."
            sleep 5
          done

          # Extract values from Infisical secret
          # Keys match Infisical naming: API_TOKEN, ACCOUNT_ID, TUNNEL_NAME
          API_TOKEN=$(kubectl get secret cloudflare-api-infisical -n cloudflare-tunnel-controller -o jsonpath='{.data.API_TOKEN}')
          ACCOUNT_ID=$(kubectl get secret cloudflare-api-infisical -n cloudflare-tunnel-controller -o jsonpath='{.data.ACCOUNT_ID}')
          TUNNEL_NAME=$(kubectl get secret cloudflare-api-infisical -n cloudflare-tunnel-controller -o jsonpath='{.data.TUNNEL_NAME}')

          # Create new secret with kebab-case keys
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: cloudflare-api
            namespace: cloudflare-tunnel-controller
          type: Opaque
          data:
            api-token: ${API_TOKEN}
            cloudflare-account-id: ${ACCOUNT_ID}
            cloudflare-tunnel-name: ${TUNNEL_NAME}
          EOF

          echo "Secret transformed successfully"
