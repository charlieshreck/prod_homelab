---
apiVersion: v1
kind: ConfigMap
metadata:
  name: matter-hub-health-check
  namespace: apps
data:
  check.sh: |
    #!/bin/sh
    set -e

    # Matter Hub health check script
    # HAMH is an SPA - all HTTP routes return HTML, no REST API.
    # We verify: (1) matter-hub HTTP server is up, (2) matter-server TCP port is reachable.

    MATTER_HUB_URL="${MATTER_HUB_URL:-http://matter-hub.apps.svc.cluster.local:8482}"
    MATTER_SERVER_HOST="${MATTER_SERVER_HOST:-matter-server.apps.svc.cluster.local}"
    # Use MATTER_SERVER_SERVICE_PORT (5580) instead of MATTER_SERVER_PORT (tcp://IP:5580)
    # Kubernetes auto-injects MATTER_SERVER_PORT as "protocol://IP:port" which breaks netcat
    MATTER_SERVER_PORT="${MATTER_SERVER_SERVICE_PORT:-5580}"

    echo "$(date -Iseconds) [INFO] Checking Matter Hub and Matter Server..."

    # Check 1: Matter Hub HTTP server responds
    HTTP_CODE=$(wget -q -O /dev/null -S "${MATTER_HUB_URL}/" 2>&1 | grep "HTTP/" | tail -1 | awk '{print $2}')
    if [ -z "$HTTP_CODE" ] || [ "$HTTP_CODE" -ge 500 ] 2>/dev/null; then
      echo "$(date -Iseconds) [CRITICAL] matter_hub_health_check: Matter Hub HTTP not responding (code: ${HTTP_CODE:-none})"
      exit 1
    fi
    echo "$(date -Iseconds) [OK] Matter Hub HTTP responding (${HTTP_CODE})"

    # Check 2: Matter Server TCP port is open (with retries)
    RETRIES=3
    RETRY_DELAY=2
    for i in $(seq 1 $RETRIES); do
      if nc -z -w10 "$MATTER_SERVER_HOST" "$MATTER_SERVER_PORT" 2>/dev/null; then
        echo "$(date -Iseconds) [OK] Matter Server port ${MATTER_SERVER_PORT} reachable"
        break
      fi
      if [ $i -lt $RETRIES ]; then
        echo "$(date -Iseconds) [WARN] Matter Server port check failed (attempt $i/$RETRIES), retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY
      else
        echo "$(date -Iseconds) [CRITICAL] matter_server_health_check: Matter Server port ${MATTER_SERVER_PORT} not reachable after $RETRIES attempts"
        exit 1
      fi
    done

    echo "$(date -Iseconds) [OK] matter_hub_health_check: All checks passed"
    exit 0
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: matter-hub-health-check
  namespace: apps
  labels:
    app: matter-hub-health-check
spec:
  schedule: "*/10 * * * *"  # Every 10 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 120
      template:
        metadata:
          labels:
            app: matter-hub-health-check
        spec:
          restartPolicy: Never
          containers:
          - name: health-check
            image: busybox:1.37
            imagePullPolicy: IfNotPresent
            command: ["/bin/sh", "/scripts/check.sh"]
            env:
            - name: MATTER_HUB_URL
              value: "http://matter-hub.apps.svc.cluster.local:8482"
            volumeMounts:
            - name: scripts
              mountPath: /scripts
            resources:
              requests:
                cpu: 10m
                memory: 16Mi
              limits:
                cpu: 50m
                memory: 32Mi
          volumes:
          - name: scripts
            configMap:
              name: matter-hub-health-check
              defaultMode: 0755
