apiVersion: apps/v1
kind: Deployment
metadata:
  name: notifiarr
  namespace: media
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: notifiarr
  template:
    metadata:
      labels:
        app: notifiarr
      annotations:
        backup.velero.io/backup-volumes: config
    spec:
      hostname: notifiarr
      containers:
      - name: notifiarr
        image: golift/notifiarr:v0.8.3
        ports:
        - name: http
          containerPort: 5454
        env:
        - name: PUID
          value: "3000"
        - name: PGID
          value: "3000"
        - name: TZ
          value: "Europe/London"
        - name: DN_API_KEY
          valueFrom:
            secretKeyRef:
              name: notifiarr-api
              key: API_KEY
        - name: DN_UI_PASSWORD
          valueFrom:
            secretKeyRef:
              name: notifiarr-api
              key: UI_PASSWORD
        - name: DN_RADARR_0_URL
          value: "http://radarr.media.svc.cluster.local:7878"
        - name: DN_RADARR_0_API_KEY
          valueFrom:
            secretKeyRef:
              name: radarr-credentials
              key: API_KEY
        - name: DN_SONARR_0_URL
          value: "http://sonarr.media.svc.cluster.local:8989"
        - name: DN_SONARR_0_API_KEY
          valueFrom:
            secretKeyRef:
              name: sonarr-credentials
              key: API_KEY
        - name: DN_PROWLARR_0_URL
          value: "http://prowlarr.media.svc.cluster.local:9696"
        - name: DN_PROWLARR_0_API_KEY
          valueFrom:
            secretKeyRef:
              name: prowlarr-credentials
              key: API_KEY
        # Transmission integration
        - name: DN_TRANSMISSION_0_URL
          value: "http://transmission.media.svc.cluster.local:9091/transmission/rpc"
        - name: DN_TRANSMISSION_0_USER
          valueFrom:
            secretKeyRef:
              name: transmission-credentials
              key: TRANSMISSION_RPC_USERNAME
        - name: DN_TRANSMISSION_0_PASS
          valueFrom:
            secretKeyRef:
              name: transmission-credentials
              key: TRANSMISSION_RPC_PASSWORD
        # Tautulli integration (only 1 instance supported - no _0_ index)
        - name: DN_TAUTULLI_URL
          value: "http://tautulli.media.svc.cluster.local:8181"
        - name: DN_TAUTULLI_API_KEY
          valueFrom:
            secretKeyRef:
              name: tautulli-credentials
              key: API_KEY
        livenessProbe:
          httpGet:
            path: /
            port: 5454
          initialDelaySeconds: 30
          periodSeconds: 30
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /
            port: 5454
          initialDelaySeconds: 5
          periodSeconds: 10
          failureThreshold: 3
        volumeMounts:
        - name: config
          mountPath: /config
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      volumes:
      - name: config
        persistentVolumeClaim:
          claimName: notifiarr-config
---
apiVersion: v1
kind: Service
metadata:
  name: notifiarr
  namespace: media
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 5454
    targetPort: 5454
  selector:
    app: notifiarr
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: notifiarr-config
  namespace: media
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: mayastor-3-replica
  resources:
    requests:
      storage: 2Gi
