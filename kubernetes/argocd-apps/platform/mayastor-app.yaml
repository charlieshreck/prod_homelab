apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mayastor-operator
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  project: default
  source:
    repoURL: https://openebs.github.io/openebs
    chart: openebs
    targetRevision: 4.2.0
    helm:
      releaseName: openebs
      skipHooks: true
      values: |
        # Enable only Mayastor engine
        engines:
          local:
            lvm:
              enabled: false
            zfs:
              enabled: false
          replicated:
            mayastor:
              enabled: true

        # Mayastor configuration for Talos Linux
        mayastor:
          # Node selector for io-engine daemonset
          io_engine:
            nodeSelector:
              openebs.io/engine: mayastor
            resources:
              limits:
                cpu: "2000m"
                memory: "2Gi"
                hugepages-2Mi: "2Gi"
              requests:
                cpu: "1000m"
                memory: "1Gi"
                hugepages-2Mi: "2Gi"

          csi:
            node:
              kubeletDir: /var/lib/kubelet

          # Resource limits for agents
          agents:
            core:
              resources:
                limits:
                  cpu: "1000m"
                  memory: "1Gi"
                requests:
                  cpu: "500m"
                  memory: "512Mi"
            ha:
              node:
                resources:
                  limits:
                    cpu: "1000m"
                    memory: "1Gi"
                  requests:
                    cpu: "500m"
                    memory: "512Mi"

          # etcd uses LocalPV (default storage class: mayastor-etcd-localpv)
          etcd:
            persistence:
              storageClass: mayastor-etcd-localpv

          # loki uses LocalPV (default storage class: mayastor-loki-localpv)
          loki-stack:
            loki:
              persistence:
                storageClassName: mayastor-loki-localpv

  destination:
    server: https://kubernetes.default.svc
    namespace: mayastor

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - SkipDryRunOnMissingResource=true  # Allow deployment even with missing CRDs
      - Replace=false  # Prevent volume attachment conflicts (RWO volumes)

  ignoreDifferences:
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      jsonPointers:
        - /spec/conversion/webhook/clientConfig/caBundle
    # Ignore pre-upgrade hook job to prevent blocking on failed hook
    - group: batch
      kind: Job
      name: openebs-pre-upgrade-hook
      jsonPointers:
        - /status
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mayastor-storage
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "4"
spec:
  project: default
  source:
    repoURL: https://github.com/charlieshreck/prod_homelab.git
    targetRevision: main
    path: kubernetes/platform/mayastor

  destination:
    server: https://kubernetes.default.svc
    namespace: mayastor

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
      - SkipDryRunOnMissingResource=true  # Allow DiskPool deployment even if CRD validation pending
      - Replace=false  # Prevent storage conflicts
