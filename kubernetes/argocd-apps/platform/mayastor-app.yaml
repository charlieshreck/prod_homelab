apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mayastor-operator
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  project: default
  sources:
    # Helm chart for Mayastor operator (correct chart without broken pre-upgrade hook)
    - repoURL: https://openebs.github.io/mayastor-extensions
      chart: mayastor
      targetRevision: 2.9.3
      helm:
        releaseName: mayastor
        valueFiles:
          - $values/kubernetes/platform/mayastor/resources/values.yaml
    # Git repository for values file
    - repoURL: https://github.com/charlieshreck/prod_homelab.git
      targetRevision: main
      ref: values

  destination:
    server: https://kubernetes.default.svc
    namespace: mayastor

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - SkipDryRunOnMissingResource=true  # Allow deployment even with missing CRDs
      - Replace=false  # Prevent volume attachment conflicts (RWO volumes)

  ignoreDifferences:
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      jsonPointers:
        - /spec/conversion/webhook/clientConfig/caBundle
    # Ignore Helm-generated JWT token (auto-generated on each Helm release)
    - group: ""
      kind: Secret
      name: mayastor-etcd-jwt-token
      jsonPointers:
        - /data
    # Ignore etcd StatefulSet template changes from Helm
    - group: apps
      kind: StatefulSet
      name: mayastor-etcd
      jsonPointers:
        - /spec/template
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mayastor-storage
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "4"
spec:
  project: default
  source:
    repoURL: https://github.com/charlieshreck/prod_homelab.git
    targetRevision: main
    path: kubernetes/platform/mayastor

  destination:
    server: https://kubernetes.default.svc
    namespace: mayastor

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
      - SkipDryRunOnMissingResource=true  # Allow DiskPool deployment even if CRD validation pending
      - Replace=false  # Prevent storage conflicts
