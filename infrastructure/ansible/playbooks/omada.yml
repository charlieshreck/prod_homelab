---
# Omada Software Controller Installation Playbook
# Installs TP-Link Omada SDN Controller on a Debian 13 LXC
#
# Usage:
#   ansible-playbook -i inventory/omada.yml playbooks/omada.yml --ask-pass
#
# Prerequisites:
#   - LXC provisioned via Terraform (10.10.0.3, VMID 200)
#   - SSH access configured

- name: Install Omada Software Controller
  hosts: omada
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Wait for system to be ready
      wait_for_connection:
        delay: 10
        timeout: 300

    - name: Gather facts after waiting
      setup:

    - name: Display target information
      debug:
        msg:
          - "Target host: {{ ansible_host }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"

  roles:
    - role: ../roles/omada

  post_tasks:
    - name: Final status summary
      debug:
        msg:
          - "=========================================="
          - "Omada Software Controller deployment complete!"
          - "=========================================="
          - ""
          - "Web UI: https://{{ ansible_host }}:8043"
          - ""
          - "Next steps:"
          - "1. Complete Omada setup wizard (https://10.10.0.3:8043)"
          - "2. Add AdGuard DNS rewrite: omada.kernow.io -> 10.10.0.1"
          - "3. Add Caddy reverse proxy: omada.kernow.io -> https://10.10.0.3:8043"
          - "4. Adopt switch: set discovery IP or manually add 10.10.0.164"
          - "5. Store Omada API credentials in Infisical: /infrastructure/omada/"
          - "6. Build MCP tools: infrastructure-mcp switch_* wrapping Omada REST API"
