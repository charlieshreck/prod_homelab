---
# Chy-Jynn Bootstrap Playbook
# Provisions a fresh Debian LXC into the Kernow homelab control environment
#
# Usage (remote):
#   ansible-playbook -i "10.10.0.100," playbook.yml -u root
#
# Usage (local):
#   ansible-playbook playbook.yml --connection=local

- name: Bootstrap Chy-Jynn Control Environment
  hosts: all
  become: true
  vars:
    # CLI tool versions (update these when upgrading)
    kubectl_version: "1.32.0"
    talosctl_version: "1.9.5"
    terraform_version: "1.10.5"
    helm_version: "3.17.0"
    argocd_version: "2.14.4"
    yq_version: "4.45.1"

    # Paths
    dotfiles_repo: "https://github.com/charlieshreck/kernow-homelab.git"
    home_path: "/home"
    dotfiles_path: "/home/dotfiles"

  tasks:
    # ===== SYSTEM PACKAGES =====
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base packages
      apt:
        name:
          # Core utilities
          - curl
          - wget
          - git
          - jq
          - unzip
          - ca-certificates
          - gnupg
          - lsb-release
          # Editors
          - neovim
          - vim-tiny
          # Shell utilities
          - screen
          - tmux
          - htop
          - tree
          - less
          # Modern CLI tools
          - ripgrep
          - fd-find
          - bat
          - fzf
          # Network
          - openssh-client
          - openssh-server
          - sshpass
          - dnsutils
          - iputils-ping
          - netcat-openbsd
          # Python & Ansible
          - python3
          - python3-pip
          - python3-venv
          - ansible
          # Node.js (for Claude CLI, Gemini CLI)
          - nodejs
          - npm
          # Build tools (for some npm packages)
          - build-essential
        state: present

    # ===== CLI TOOLS WITH CHECKSUM VERIFICATION =====
    - name: Install kubectl
      get_url:
        url: "https://dl.k8s.io/release/v{{ kubectl_version }}/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'
        checksum: "sha256:https://dl.k8s.io/release/v{{ kubectl_version }}/bin/linux/amd64/kubectl.sha256"

    - name: Install talosctl
      get_url:
        url: "https://github.com/siderolabs/talos/releases/download/v{{ talosctl_version }}/talosctl-linux-amd64"
        dest: /usr/local/bin/talosctl
        mode: '0755'
        # Note: Talos provides SHA256 in release notes, not as separate file
        # Verify manually when updating versions

    - name: Download terraform zip
      get_url:
        url: "https://releases.hashicorp.com/terraform/{{ terraform_version }}/terraform_{{ terraform_version }}_linux_amd64.zip"
        dest: /tmp/terraform.zip
        checksum: "sha256:https://releases.hashicorp.com/terraform/{{ terraform_version }}/terraform_{{ terraform_version }}_SHA256SUMS"

    - name: Extract terraform
      unarchive:
        src: /tmp/terraform.zip
        dest: /usr/local/bin/
        remote_src: yes
        mode: '0755'

    - name: Install helm
      unarchive:
        src: "https://get.helm.sh/helm-v{{ helm_version }}-linux-amd64.tar.gz"
        dest: /tmp/
        remote_src: yes
      register: helm_extract

    - name: Move helm binary
      copy:
        src: /tmp/linux-amd64/helm
        dest: /usr/local/bin/helm
        mode: '0755'
        remote_src: yes
      when: helm_extract.changed

    - name: Install argocd CLI
      get_url:
        url: "https://github.com/argoproj/argo-cd/releases/download/v{{ argocd_version }}/argocd-linux-amd64"
        dest: /usr/local/bin/argocd
        mode: '0755'

    - name: Install yq
      get_url:
        url: "https://github.com/mikefarah/yq/releases/download/v{{ yq_version }}/yq_linux_amd64"
        dest: /usr/local/bin/yq
        mode: '0755'
        checksum: "sha256:https://github.com/mikefarah/yq/releases/download/v{{ yq_version }}/checksums"

    # ===== NPM GLOBAL PACKAGES =====
    - name: Install Claude Code CLI
      npm:
        name: "@anthropic-ai/claude-code"
        global: yes
        state: present

    - name: Install Gemini CLI
      npm:
        name: "@google/gemini-cli"
        global: yes
        state: present

    # ===== SYMLINKS FOR MODERN TOOLS =====
    - name: Create bat symlink
      file:
        src: /usr/bin/batcat
        dest: /usr/local/bin/bat
        state: link

    - name: Create fd symlink
      file:
        src: /usr/bin/fdfind
        dest: /usr/local/bin/fd
        state: link

    # ===== CLONE REPOS (if not exists) =====
    - name: Check if repos already cloned
      stat:
        path: "{{ home_path }}/.git"
      register: repos_exist

    - name: Clone kernow-homelab with submodules
      git:
        repo: "{{ dotfiles_repo }}"
        dest: "{{ home_path }}"
        recursive: yes
        accept_hostkey: yes
      when: not repos_exist.stat.exists
      ignore_errors: yes  # May fail without SSH key, user can clone manually

    # ===== DOTFILES SYMLINKS =====
    - name: Check if dotfiles exist
      stat:
        path: "{{ dotfiles_path }}"
      register: dotfiles_exist

    - name: Symlink bashrc
      file:
        src: "{{ dotfiles_path }}/bashrc"
        dest: /root/.bashrc
        state: link
        force: yes
      when: dotfiles_exist.stat.exists

    - name: Symlink gitconfig
      file:
        src: "{{ dotfiles_path }}/gitconfig"
        dest: /root/.gitconfig
        state: link
        force: yes
      when: dotfiles_exist.stat.exists

    - name: Symlink ripgreprc
      file:
        src: "{{ dotfiles_path }}/ripgreprc"
        dest: /root/.ripgreprc
        state: link
        force: yes
      when: dotfiles_exist.stat.exists

    - name: Symlink profile.d script
      file:
        src: "{{ dotfiles_path }}/profile.d/chy-jynn.sh"
        dest: /etc/profile.d/chy-jynn.sh
        state: link
        force: yes
      when: dotfiles_exist.stat.exists

    - name: Symlink claude-ref directory
      file:
        src: "{{ dotfiles_path }}/claude-ref"
        dest: /root/.claude-ref
        state: link
        force: yes
      when: dotfiles_exist.stat.exists

    # Directory-based symlink for scripts (simpler than individual symlinks)
    - name: Symlink dotfiles scripts directory
      file:
        src: "{{ dotfiles_path }}/scripts"
        dest: /usr/local/bin/chy-jynn-scripts
        state: link
        force: yes
      when: dotfiles_exist.stat.exists

    - name: Add scripts directory to PATH in profile.d
      lineinfile:
        path: /etc/profile.d/chy-jynn-path.sh
        line: 'export PATH="/usr/local/bin/chy-jynn-scripts:$PATH"'
        create: yes
        mode: '0644'

    # ===== DIRECTORIES =====
    - name: Create .config directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0700'
      loop:
        - /root/.config
        - /root/.config/infisical
        - /root/.local/bin
        - /root/.cache/helm
        - /root/.config/helm
        - /root/.local/share/helm

    # ===== SSH CONFIG =====
    - name: Ensure .ssh directory exists
      file:
        path: /root/.ssh
        state: directory
        mode: '0700'

    - name: Configure SSH defaults
      copy:
        dest: /root/.ssh/config
        mode: '0600'
        content: |
          Host *
            StrictHostKeyChecking accept-new
            ServerAliveInterval 60
            ServerAliveCountMax 3

    # ===== LOCALE =====
    - name: Ensure locale is set
      locale_gen:
        name: en_US.UTF-8
        state: present
      ignore_errors: yes

    # ===== VALIDATION =====
    - name: Run environment validation
      command: /usr/local/bin/chy-jynn-scripts/chy-jynn-verify
      register: verify_output
      changed_when: false
      failed_when: false
      when: dotfiles_exist.stat.exists

    - name: Display validation results
      debug:
        var: verify_output.stdout_lines
      when: verify_output is defined and verify_output.stdout_lines is defined

    # ===== FINAL MESSAGE =====
    - name: Bootstrap complete
      debug:
        msg: |
          Chy-Jynn bootstrap complete!

          Next steps:
          1. Clone repos (if not done): cd /home && git clone --recurse-submodules git@github.com:charlieshreck/kernow-homelab.git .
          2. Copy SSH keys or generate new ones
          3. Setup Infisical: /root/.config/infisical/get-token.sh
          4. Authenticate Claude: claude
          5. Verify environment: chy-jynn-verify
          6. Check clusters: cluster-health
