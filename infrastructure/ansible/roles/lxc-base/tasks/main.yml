---
# Common setup tasks for all LXC containers

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install base packages
  apt:
    name: "{{ lxc_base_packages }}"
    state: present

# Timezone configuration
- name: Set timezone to {{ lxc_timezone }}
  timezone:
    name: "{{ lxc_timezone }}"

# DNS configuration
- name: Configure resolv.conf to use {{ dns_server }}
  copy:
    content: |
      nameserver {{ dns_server }}
      search kernow.io
    dest: /etc/resolv.conf
    mode: '0644'
    backup: yes

# Sysctl optimizations (may fail in LXC containers due to namespace restrictions)
- name: Apply sysctl optimizations
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
    sysctl_file: /etc/sysctl.d/99-lxc-optimizations.conf
  loop: "{{ lxc_sysctl_settings | dict2items }}"
  failed_when: false

# SSH authorized keys
- name: Ensure .ssh directory exists
  file:
    path: /root/.ssh
    state: directory
    mode: '0700'
    owner: root
    group: root

- name: Deploy SSH authorized keys
  authorized_key:
    user: root
    key: "{{ item }}"
    state: present
  loop: "{{ lxc_authorized_keys }}"
  when: lxc_authorized_keys | length > 0

# Infisical CLI installation (via official Cloudsmith repo)
- name: Check if Infisical CLI is already installed
  command: which infisical
  register: infisical_check
  changed_when: false
  failed_when: false

- name: Install Infisical CLI via setup script
  shell: |
    curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | bash
    apt-get install -y infisical
  args:
    creates: /usr/bin/infisical
  when: infisical_check.rc != 0

- name: Verify Infisical CLI installation
  command: infisical --version
  register: infisical_version
  changed_when: false
  failed_when: false

- name: Display Infisical CLI version
  debug:
    msg: "Infisical CLI: {{ infisical_version.stdout | default('not installed') }}"

# Infisical machine identity for runtime secret injection
- name: Create Infisical config directory
  file:
    path: "{{ infisical_config_dir }}"
    state: directory
    mode: '0700'
    owner: root
    group: root

- name: Deploy machine identity config
  template:
    src: machine-identity.json.j2
    dest: "{{ infisical_config_dir }}/machine-identity.json"
    mode: '0600'
    owner: root
    group: root
  when: infisical_client_id | length > 0

- name: Deploy infisical-env helper script
  template:
    src: infisical-env.sh.j2
    dest: /usr/local/bin/infisical-env.sh
    mode: '0755'
    owner: root
    group: root
