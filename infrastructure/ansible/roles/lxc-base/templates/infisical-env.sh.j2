#!/bin/bash
# Fetch Infisical secrets and output as export statements
# Deployed by Ansible lxc-base role
# Usage: eval $(infisical-env.sh /platform/tamar)
set -euo pipefail

SECRET_PATH="${1:?Usage: infisical-env.sh <secret-path>}"
CONFIG_FILE="{{ infisical_config_dir }}/machine-identity.json"

CLIENT_ID=$(jq -r '.clientId' "$CONFIG_FILE")
CLIENT_SECRET=$(jq -r '.clientSecret' "$CONFIG_FILE")
WORKSPACE_ID=$(jq -r '.workspaceId' "$CONFIG_FILE")
ENVIRONMENT=$(jq -r '.environment' "$CONFIG_FILE")
BASE_URL=$(jq -r '.baseUrl' "$CONFIG_FILE")

TOKEN=$(curl -s -X POST "${BASE_URL}/api/v1/auth/universal-auth/login" \
    -H "Content-Type: application/json" \
    -d "{\"clientId\":\"${CLIENT_ID}\",\"clientSecret\":\"${CLIENT_SECRET}\"}" \
    | jq -r '.accessToken')

if [[ -z "$TOKEN" || "$TOKEN" == "null" ]]; then
    echo "Error: Failed to authenticate with Infisical" >&2
    exit 1
fi

curl -s -H "Authorization: Bearer $TOKEN" \
    "${BASE_URL}/api/v3/secrets/raw?workspaceId=${WORKSPACE_ID}&environment=${ENVIRONMENT}&secretPath=${SECRET_PATH}&include_imports=false" \
    | jq -r '.secrets[] | select(.secretPath == "'"$SECRET_PATH"'") | "export \(.secretKey)=\(.secretValue)"'
