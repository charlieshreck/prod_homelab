---
# Main tasks for plex-nvidia role

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install prerequisites
  apt:
    name:
      - curl
      - gnupg
      - ca-certificates
      - apt-transport-https
      - nfs-common
      - dkms
      - build-essential
    state: present

# Install kernel headers before nvidia driver (required for DKMS to build modules)
- name: Install kernel headers for current kernel
  apt:
    name: "linux-headers-{{ ansible_kernel }}"
    state: present

# Enable non-free repos for Nvidia drivers (Debian 13 deb822 format)
- name: Enable non-free and non-free-firmware repos
  copy:
    content: |
      Types: deb deb-src
      URIs: http://deb.debian.org/debian
      Suites: trixie trixie-updates trixie-backports
      Components: main contrib non-free non-free-firmware
      Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

      Types: deb deb-src
      URIs: http://deb.debian.org/debian-security
      Suites: trixie-security
      Components: main contrib non-free non-free-firmware
      Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg
    dest: /etc/apt/sources.list.d/debian.sources
    mode: '0644'
    backup: yes

- name: Update apt cache after enabling non-free
  apt:
    update_cache: yes

- name: Create keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Download Nvidia GPG key
  get_url:
    url: https://nvidia.github.io/libnvidia-container/gpgkey
    dest: /etc/apt/keyrings/nvidia-container-toolkit.asc
    mode: '0644'

- name: Get system architecture
  command: dpkg --print-architecture
  register: dpkg_arch
  changed_when: false

- name: Add Nvidia container toolkit repository
  copy:
    content: |
      deb [signed-by=/etc/apt/keyrings/nvidia-container-toolkit.asc] https://nvidia.github.io/libnvidia-container/stable/deb/{{ dpkg_arch.stdout }} /
    dest: /etc/apt/sources.list.d/nvidia-container-toolkit.list
    mode: '0644'

- name: Update apt cache after adding Nvidia repo
  apt:
    update_cache: yes

- name: Install Nvidia drivers and Docker
  apt:
    name:
      - nvidia-driver
      - nvidia-container-toolkit
      - docker.io
      - docker-compose
    state: present

# Ensure nvidia module is loaded (may require reboot if first install, but DKMS should handle it)
- name: Load nvidia kernel module
  modprobe:
    name: nvidia
    state: present
  ignore_errors: yes
  register: nvidia_modprobe

# Reboot only if nvidia module failed to load (first-time driver install)
- name: Reboot if nvidia module not loaded
  reboot:
    msg: "Rebooting to load Nvidia drivers"
    reboot_timeout: 600
  when: nvidia_modprobe.failed | default(false)

- name: Ensure Docker service is running
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Configure Nvidia container runtime for Docker
  command: nvidia-ctk runtime configure --runtime=docker
  register: nvidia_runtime_config
  changed_when: nvidia_runtime_config.rc == 0
  notify:
    - Restart Docker

- name: Flush handlers to restart Docker
  meta: flush_handlers

- name: Verify Nvidia GPU is available
  command: nvidia-smi
  register: nvidia_smi_output
  changed_when: false
  failed_when: nvidia_smi_output.rc != 0

- name: Display GPU information
  debug:
    msg: "{{ nvidia_smi_output.stdout_lines }}"

- name: Create Plex directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ plex_config_dir }}"
    - "{{ plex_compose_dir }}"
    - "{{ plex_mount_point }}"

- name: Mount TrueNAS NFS share
  mount:
    src: "{{ plex_nfs_server }}:{{ plex_nfs_path }}"
    path: "{{ plex_mount_point }}"
    fstype: nfs
    opts: "{{ plex_nfs_options }}"
    state: mounted

- name: Verify NFS mount
  command: "ls -la {{ plex_mount_point }}"
  register: nfs_mount_check
  changed_when: false

- name: Display NFS mount contents
  debug:
    msg: "{{ nfs_mount_check.stdout_lines }}"

- name: Deploy docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: "{{ plex_compose_dir }}/docker-compose.yml"
    mode: '0644'
  notify:
    - Restart Plex

- name: Start Plex container
  community.docker.docker_compose_v2:
    project_src: "{{ plex_compose_dir }}"
    state: present
  register: plex_compose_output

# Watchtower for automatic container updates
- name: Deploy Watchtower for auto-updates
  community.docker.docker_container:
    name: watchtower
    image: containrrr/watchtower:latest
    restart_policy: unless-stopped
    env:
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_SCHEDULE: "0 0 4 * * *"
      WATCHTOWER_INCLUDE_STOPPED: "true"
      DOCKER_API_VERSION: "1.44"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

- name: Wait for Plex to be ready
  wait_for:
    host: localhost
    port: 32400
    delay: 10
    timeout: 120

- name: Display Plex container status
  command: docker ps --filter name=plex
  register: plex_status
  changed_when: false

- name: Show Plex container info
  debug:
    msg: "{{ plex_status.stdout_lines }}"
